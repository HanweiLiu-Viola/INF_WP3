services:
  func_conn:
    build:
      context: ../
      dockerfile: docker/FUNC_Conn/Dockerfile
    image: inf_wp3/func_conn:latest
    container_name: func_conn
    env_file:
      - ../.env
    working_dir: /workspace

    # 文件挂载：代码 + 共享数据
    volumes:
      - ../:/workspace                                     # 本地项目根 → 容器 /workspace
      - ${SHARED_HOST_PATH:-../shared}:/workspace/shared  # 共享数据目录 → 容器 /workspace/shared
      - /tmp/.X11-unix:/tmp/.X11-unix:ro
      - /dev/dri:/dev/dri
      
    ports:
      - "${JUPYTER_PORT:-8888}:8888"

    # 环境变量 & X11 显示设定（如果要弹窗模式）
    environment:
      - DISPLAY=${DISPLAY}
      - QT_QPA_PLATFORM=xcb
      - MNE_3D_BACKEND=pyvistaqt
      - PYVISTA_OFF_SCREEN=false
      - XDG_RUNTIME_DIR=/tmp/runtime-root
      - LIBGL_ALWAYS_SOFTWARE=1
      - MESA_GL_VERSION_OVERRIDE=3.3
      - MESA_LOADER_DRIVER_OVERRIDE=llvmpipe
      
    # 启动命令：直接运行 Jupyter，不用 xvfb
    command: >
      bash -lc "mamba run -n inf \
      jupyter lab --ip=0.0.0.0 --no-browser --allow-root \
      --NotebookApp.token=\"\" --NotebookApp.password=\"\""

    tty: true

  struct_conn:
    build:
      context: ../
      dockerfile: docker/STRUCT_Conn/Dockerfile
    image: inf_wp3/struct_conn:latest
    container_name: struct_conn
    env_file:
      - ../.env
    working_dir: /workspace
    volumes:
      - ../:/workspace
      - ${SHARED_HOST_PATH:-../shared}:/workspace/shared
    command: bash -lc "sleep infinity"
    tty: true

  brain_model:
    build:
      context: ../
      dockerfile: docker/BRAIN_Model/Dockerfile
    image: inf_wp3/brain_model:latest
    container_name: brain_model
    env_file:
      - ../.env
    working_dir: /workspace
    volumes:
      - ../:/workspace
      - ${SHARED_HOST_PATH:-../shared}:/workspace/shared
    command: bash -lc "sleep infinity"
    tty: true
